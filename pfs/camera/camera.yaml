#
# LSST Data Management System
# Copyright 2017 LSST Corporation.
#
# This product includes software developed by the
# LSST Project (http://www.lsst.org/).
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the LSST License Statement and
# the GNU General Public License along with this program.  If not,
# see <http://www.lsstcorp.org/LegalNotices/>.
#
#

name : "PFS"
plateScale : 1.0                        # plate scale; not well defined for a spectrograph

# Provide transformations *from* the nativeSys *to* the specified system (e.g. FieldAngle)
transforms :
  nativeSys : FocalPlane
  FieldAngle :
    transformType : radial
    coeffs :        [0.0, 1.0, 0.0]     # radial distortion coefficients (c_0 + c_1 r + c_2 r^2 + ...)


#
# A single amplifier ("segment" to the camera team)
#
AMP : &AMP
    # trimmed
    hdu : 1                             # Only one HDU in the file

    flipXY :     [False, False]
    perAmpData : False                  # is the amp data split across multiple HDUs/Files?

    #                         [[x0,  y0], [xSize, ySize]]
    rawBBox                 : [[0,    0], [552,    4300]] # total size of one amp's raw data
    
    rawDataBBox             : [[8,   48], [512,    4176]] # data region in raw data
    rawSerialPrescanBBox    : [[0,   48], [8,      4176]] # serial prescan (we could use the first 48 too)
    rawSerialOverscanBBox   : [[520, 48], [32,     4176]] # serial overscan
    rawParallelPrescanBBox  : [[0,    1], [0,         0]] # pixels digitised before first parallel transfer
    rawParallelOverscanBBox : [[8, 4224], [512,      76]] # parallel overscan

    saturation : 65535                  # saturation level, DN XXX Should this be in electrons?

    # Linearity correction is still under discussion, so this is a placeholder.
    linearityType : PROPORTIONAL
    linearityThreshold : 0
    linearityMax : 65535                # == saturation
    linearityCoeffs : [0, 65535]        # == [linearityThreshold, linearityMax]
#
# H4RG "amp", actually the entire Chip
#
H4RG : &H4RG
    hdu : 1                             # Only one HDU in the file

    ixy : [0, 0]
    readCorner : LL
    flipXY :     [False, False]
    perAmpData : False                  # is the amp data split across multiple HDUs/Files?

    #                         [[x0,  y0], [xSize, ySize]]
    rawBBox                 : [[0,    0], [4096,   4096]] # total size of raw data

    rawDataBBox             : [[0,    0], [4096,   4096]] # data region in raw data
    rawSerialPrescanBBox    : [[0,    0], [0,         0]] # serial prescan (we could use the first 48 too)
    rawSerialOverscanBBox   : [[0,    0], [0,         0]] # serial overscan
    rawParallelPrescanBBox  : [[0,    0], [0,         0]] # pixels digitised before first parallel transfer
    rawParallelOverscanBBox : [[0,    0], [0,         0]] # parallel overscan

    saturation : 65535                  # saturation level, DN XXX Should this be in electrons?

    # Linearity correction is still under discussion, so this is a placeholder.
    linearityType : PROPORTIONAL
    linearityThreshold : 0
    linearityMax : 65535                # == saturation
    linearityCoeffs : [0, 65535]        # == [linearityThreshold, linearityMax]

#
# A single detector;  each optical detector is a Pair of Hamamatsu CCDs with 2*4 amplifiers
#
Detector : &Detector
    detectorType : .nan
    refpos : [2048, 2088]               # centre of chip
    offset : [.nan, .nan]
    # 
    bbox : [[0, 0], [4095, 4175]]       # total bbox of trimmed detector
    pixelSize : [0.015, 0.015]          # in mm
    transformDict : {nativeSys : 'Pixels', transforms : None}
    transposeDetector : False
    pitch : 0.0                         # (degrees)
    yaw : 0.0                           # rotation in plane of camera (degrees)
    roll : 0.0                          # (degrees)

    amplifiers : {}
#
# Now the guide cameras
#
# A single amplifier
#
AG_AMP0 : &AG_AMP0
    # trimmed
    hdu : 1                             # Only one HDU in the file

    flipXY :     [False, False]
    perAmpData : False                  # is the amp data split across multiple HDUs/Files?

    #                         [[x0,  y0], [xSize, ySize]]
    rawBBox                 : [[0,    0], [536,    1033]] # total size of one amp's raw data

    rawDataBBox             : [[24,   9], [512,    1024]] # data region in raw data
    rawSerialPrescanBBox    : [[0,    0], [8,      1033]] # serial prescan
    rawSerialOverscanBBox   : [[8,    0], [14,     1033]] # serial overscan
    rawParallelPrescanBBox  : [[0,    1], [0,         0]] # pixels digitised before first parallel transfer
    rawParallelOverscanBBox : [[0,    0], [536,       8]] # parallel overscan

    saturation : 65535                  # saturation level, DN XXX Should this be in electrons?

    # Linearity correction is still under discussion, so this is a placeholder.
    linearityType : PROPORTIONAL
    linearityThreshold : 0
    linearityMax : 65535                # == saturation
    linearityCoeffs : [0, 65535]        # == [linearityThreshold, linearityMax]

AG_AMP1 : &AG_AMP1
    << : *AG_AMP0
    #                         [[x0,  y0], [xSize, ySize]]
    rawBBox                 : [[0,    0], [536,    1033]] # total size of one amp's raw data

    rawDataBBox             : [[0,  9], [512,    1024]] # data region in raw data
    rawSerialPrescanBBox    : [[528, 0], [8,      1033]] # serial prescan
    rawSerialOverscanBBox   : [[514,    0], [14,     1033]] # serial overscan
    rawParallelPrescanBBox  : [[0,    1], [0,         0]] # pixels digitised before first parallel transfer
    rawParallelOverscanBBox : [[0,    0], [536,       8]] # parallel overscan

#
# A single detector;
#
AG_Detector : &AG_Detector
    detectorType : 4                    # AG CCD
    refpos : [536, 516.5]               # centre of chip
    offset : [.nan, .nan]
    #      [[x0,y0], [   x1,  y1]]
    bbox : [[0,  0], [1023, 1023]]      # total bbox of trimmed detector
    pixelSize : [0.015, 0.015]          # in mm (unknown)
    transformDict : {nativeSys : 'Pixels', transforms : None}
    transposeDetector : False
    pitch : 0.0                         # (degrees)
    yaw : 0.0                           # rotation in plane of camera (degrees)
    roll : 0.0                          # (degrees)

    amplifiers : {}
#
# Define our specific devices
#
# All the cameras present in this file.  Each camera is a Pair of Hamamatsu Detectors with 2*4 amplifiers
#
# Define our specific devices.  Some are HgCdTe -- change yamlCamera.py CCDs -> Detectors
#
# The layout specified by "offset" is:
#   n1 n2 n3 n4
#   r1 r2 r3 r4
#   b1 b2 b3 b4
# with 1% gaps between the chips
#
CCDs : &CCDs
    r1 : &CCD                           # Spectrograph 1, red arm
        << : *Detector
        detectorType : 0                # r CCD
        id : 1
        serial : Hamamatsu r1
        offset : [-93.1, 0.0]           # mm
        crosstalk : [
          0.00000000e+00,  2.24570807e-05, -1.42245307e-04, -1.07798790e-04,
          5.23427422e-05,  5.17355048e-05,  6.87106226e-05,  0.00000000e+00,
          1.47098100e-05,  0.00000000e+00, -1.40583119e-04, -1.49551591e-04,
          5.84586892e-05,  2.91378917e-05,  1.26252967e-04,  7.08880216e-05,
          -1.28526401e-04, -5.16820869e-05,  0.00000000e+00,  1.46487600e-04,
          5.04504134e-05,  1.06000785e-04,  3.31478448e-04, -5.90582668e-06,
          -9.12912656e-05, -6.74010910e-05,  2.14835484e-04,  0.00000000e+00,
          1.78262703e-04,  4.73332256e-05,  5.71160521e-05,  6.96162543e-05,
          4.56494533e-05,  4.61681035e-05, -1.70259052e-05,  1.05959351e-04,
          0.00000000e+00,  6.90640883e-05,  6.73041985e-05, -1.48531125e-04,
          9.87909700e-07,  8.27332225e-06,  1.46561293e-05, -2.28440864e-05,
          -4.48820736e-05,  0.00000000e+00,  2.21603795e-05, -1.52303548e-04,
          0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
          0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
          0.00000000e+00,  2.42205387e-05, -2.08053587e-05,  1.86118246e-05,
          -1.31911061e-04, -1.22628313e-04,  5.47859963e-06,  0.00000000e+00
        ]

        amplifiers:
            "0": &A0
                <<: *AMP
                ixy : [0, 0]
                readCorner : LL
                gain : 1.181
                readNoise : 4.423752
            "1": &A1
                <<: *A0
                ixy : [1, 0]
                readCorner : LR
                flipXY : [True, False]
                gain : 1.170
                readNoise : 4.266983
            "2": &A2
                <<: *A0
                ixy : [2, 0]
                gain : 1.174
                readNoise : 4.403465
            "3": &A3
                <<: *A1
                ixy : [3, 0]
                gain : 1.196
                readNoise : 4.178715
            "4": &A4
                <<: *A0
                ixy : [4, 0]
                gain : 1.250
                readNoise : 3.960904
            "5": &A5
                <<: *A1
                ixy : [5, 0]
                gain : 1.259
                readNoise : 4.411193
            "6": &A6
                <<: *A0
                ixy : [6, 0]
                gain : 1.248
                readNoise : 5.042430
            "7": &A7
                <<: *A1
                ixy : [7, 0]
                gain : 1.207
                readNoise : 4.181415
    m1 :  # m1 is actually r1
        <<: *CCD
        id : -1

    b1 :                                # Spectrograph 1, blue arm
        << : *Detector
        detectorType : 1                # b CCD
        id : 0
        serial : Hamamatsu b1
        offset : [-93.1, -65.1]         # mm

        amplifiers:
            "0":
                <<: *A0
                gain : 1.336
                readNoise : 4.109
            "1":
                <<: *A1
                gain : 1.304
                readNoise : 3.994
            "2":
                <<: *A2
                gain : 1.343
                readNoise : 4.064
            "3":
                <<: *A3
                gain : 1.271
                readNoise : 4.04
            "4":
                <<: *A4
                gain : 1.336
                readNoise : 4.172
            "5":
                <<: *A5
                gain : 1.322
                readNoise : 4.056
            "6":
                <<: *A6
                gain : 1.344
                readNoise : 4.097
            "7":
                <<: *A7
                gain : 1.273
                readNoise : 4.452

    n1 : &n1
        << : *Detector

        detectorType : 2                # H4RG
        id : 2
        serial : "TBD"
        offset : [-93.1, 65.1]          # mm
        yaw : 270.0                     # rotation in plane of camera (degrees)

        amplifiers:                     # only 1 amplifier (well, really 16M amplifiers but treated as 1)
            "0":
                <<: *H4RG
                gain : 1.00             # will be multiplied by W_H4GAIN
                readNoise : 10

    b2:
      <<: *CCD
      id: 3
      serial : Hamamatsu b2
      offset : [-28.0, -65.1]         # mm
      amplifiers:
        "0":
          <<: *A0
          gain: 1.295
          readNoise: 4.81
        "1":
          <<: *A1
          gain: 2.596
          readNoise: 7.15
        "2":
          <<: *A2
          gain: 1.319
          readNoise: 4.42
        "3":
          <<: *A3
          gain: 1.345
          readNoise: 4.42
        "4":
          <<: *A4
          gain: 1.349
          readNoise: 4.78
        "5":
          <<: *A5
          gain: 1.333
          readNoise: 4.67
        "6":
          <<: *A6
          gain: 1.363
          readNoise: 4.88
        "7":
          <<: *A7
          gain: 1.326
          readNoise: 4.57
    r2: &r2
      <<: *CCD
      id: 4
      serial : Hamamatsu r2
      offset : [-28.0, 0.0]           # mm
      amplifiers:
        "0":
          <<: *A0
          gain: 1.090
          readNoise: 3.84
        "1":
          <<: *A1
          gain: 1.093
          readNoise: 3.74
        "2":
          <<: *A2
          gain: 1.084
          readNoise: 3.78
        "3":
          <<: *A3
          gain: 1.087
          readNoise: 3.83
        "4":
          <<: *A4
          gain: 1.043
          readNoise: 3.70
        "5":
          <<: *A5
          gain: 1.070
          readNoise: 4.54
        "6":
          <<: *A6
          gain: 1.065
          readNoise: 4.61
        "7":
          <<: *A7
          gain: 1.108
          readNoise: 3.82
    n2:
      <<: *n1
      id: 5
      serial : "18315"
      offset : [-28.0, 65.1]           # mm
    m2:                                # == r2
      <<: *r2
      id: -4

    b3:
      <<: *CCD
      id: 6
      serial : Hamamatsu b3
      offset : [37.1, -65.1]         # mm
      amplifiers:
        "0":
          <<: *A0
          gain: 1.217
          readNoise: 3.885
        "1":
          <<: *A1
          gain: 1.248
          readNoise: 3.824
        "2":
          <<: *A2
          gain: 1.246
          readNoise: 3.823
        "3":
          <<: *A3
          gain: 1.195
          readNoise: 3.825
        "4":
          <<: *A4
          gain: 1.175
          readNoise: 3.999
        "5":
          <<: *A5
          gain: 1.1999
          readNoise: 3.81
        "6":
          <<: *A6
          gain: 1.22
          readNoise: 3.891
        "7":
          <<: *A7
          gain: 1.232
          readNoise: 3.874
    r3: &r3
      <<: *CCD
      id: 7
      serial : Hamamatsu r3
      offset : [37.1, 0.0]           # mm
      amplifiers:
        "0":
          <<: *A0
          gain: 1.090
          readNoise: 4.285
        "1":
          <<: *A1
          gain: 1.093
          readNoise: 3.64
        "2":
          <<: *A2
          gain: 1.083
          readNoise: 3.67
        "3":
          <<: *A3
          gain: 1.087
          readNoise: 3.70
        "4":
          <<: *A4
          gain: 1.040
          readNoise: 3.47
        "5":
          <<: *A5
          gain: 1.070
          readNoise: 3.44
        "6":
          <<: *A6
          gain: 1.064
          readNoise: 3.56
        "7":
          <<: *A7
          gain: 1.108
          readNoise: 3.75
    n3:
      <<: *n1
      id: 8
      serial : "18660"
      offset : [37.1, 65.1]           # mm
    m3:
      <<: *r3
      id: -7                            # == r3
      offset : [37.1, 130.2]         # mm

    b4:
      <<: *CCD
      id: 9
      serial : Hamamatsu b4
      offset : [102.2, -65.1]         # mm
      amplifiers:
        "0":
          <<: *A0
          gain: 1.223
          readNoise: 4.38
        "1":
          <<: *A1
          gain: 1.201
          readNoise: 4.04
        "2":
          <<: *A2
          gain: 1.207
          readNoise: 4.09
        "3":
          <<: *A3
          gain: 1.213
          readNoise: 4.03
        "4":
          <<: *A4
          gain: 1.249
          readNoise: 4.35
        "5":
          <<: *A5
          gain: 1.249
          readNoise: 4.03
        "6":
          <<: *A6
          gain: 1.256
          readNoise: 4.12
        "7":
          <<: *A7
          gain: 1.213
          readNoise: 4.19
    r4: &r4
      <<: *CCD
      id: 10
      serial : Hamamatsu r4
      offset : [102.2, 0.0]           # mm
      amplifiers:
        "0":
          <<: *A0
          gain: 1.124
          readNoise: 3.80
        "1":
          <<: *A1
          gain: 1.092
          readNoise: 3.78
        "2":
          <<: *A2
          gain: 1.099
          readNoise: 3.65
        "3":
          <<: *A3
          gain: 1.075
          readNoise: 3.77
        "4":
          <<: *A4
          gain: 1.065
          readNoise: 3.63
        "5":
          <<: *A5
          gain: 1.057
          readNoise: 3.53
        "6":
          <<: *A6
          gain: 1.053
          readNoise: 3.54
        "7":
          <<: *A7
          gain: 1.074
          readNoise: 3.73
    n4:
      <<: *n1
      id: 11
      serial : "TBD"
      offset : [102.2, 65.1]           # mm
    m4:
      <<: *r4
      id: -10
    #
    # Now the autoguiders
    #
    AG1 :
        << : *AG_Detector
        id : 101
        serial : AG 1
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0": &AG_A0
                <<: *AG_AMP0
                ixy : [0, 0]
                readCorner : LL
                gain :  1.015
                readNoise : 1

            "1": &AG_A1
                <<: *AG_AMP1
                ixy : [1, 0]
                readCorner : LR
                gain : 0.985
                readNoise : 1

    AG2 :
        << : *AG_Detector
        id : 102
        serial : AG 2
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain :  1.024

            "1":
                <<: *AG_A1
                gain : 0.976

    AG3 :
        << : *AG_Detector
        id : 103
        serial : AG 3
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 0.931

            "1":
                <<: *AG_A1
                gain : 1.069

    AG4 :
        << : *AG_Detector
        id : 104
        serial : AG 4
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 1.002

            "1":
                <<: *AG_A1
                gain : 0.998

    AG5 :
        << : *AG_Detector
        id : 105
        serial : AG 5
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 0.985

            "1":
                <<: *AG_A1
                gain : 1.015

    AG6 :
        << : *AG_Detector
        id : 106
        serial : AG 6
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 0.994

            "1":
                <<: *AG_A1
                gain : 1.006
