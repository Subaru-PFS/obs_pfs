#
# LSST Data Management System
# Copyright 2017 LSST Corporation.
#
# This product includes software developed by the
# LSST Project (http://www.lsst.org/).
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the LSST License Statement and
# the GNU General Public License along with this program.  If not,
# see <http://www.lsstcorp.org/LegalNotices/>.
#
#

name : "PFS"
plateScale : 1.0                        # plate scale; not well defined for a spectrograph

# Provide transformations *from* the nativeSys *to* the specified system (e.g. FieldAngle)
transforms :
  nativeSys : FocalPlane
  FieldAngle :
    transformType : radial
    coeffs :        [0.0, 1.0, 0.0]     # radial distortion coefficients (c_0 + c_1 r + c_2 r^2 + ...)


#
# A single amplifier ("segment" to the camera team)
#
AMP : &AMP
    # trimmed
    hdu : 1                             # Only one HDU in the file

    flipXY :     [False, False]
    perAmpData : False                  # is the amp data split across multiple HDUs/Files?

    #                         [[x0,  y0], [xSize, ySize]]
    rawBBox                 : [[0,    0], [552,    4300]] # total size of one amp's raw data
    
    rawDataBBox             : [[8,   48], [512,    4176]] # data region in raw data
    rawSerialPrescanBBox    : [[0,   48], [8,      4176]] # serial prescan (we could use the first 48 too)
    rawSerialOverscanBBox   : [[520, 48], [32,     4176]] # serial overscan
    rawParallelPrescanBBox  : [[0,    1], [0,         0]] # pixels digitised before first parallel transfer
    rawParallelOverscanBBox : [[8, 4224], [512,      76]] # parallel overscan

    saturation : 65535                  # saturation level, DN XXX Should this be in electrons?

    # Linearity correction is still under discussion, so this is a placeholder.
    linearityType : PROPORTIONAL
    linearityThreshold : 0
    linearityMax : 65535                # == saturation
    linearityCoeffs : [0, 65535]        # == [linearityThreshold, linearityMax]

#
# A single detector;  each optical detector is a Pair of Hamamatsu CCDs with 2*4 amplifiers
#
Detector : &Detector
    detectorType : .nan
    refpos : [2048, 2088]               # centre of chip
    offset : [.nan, .nan]
    # 
    bbox : [[0, 0], [4095, 4175]]       # total bbox of trimmed detector
    pixelSize : [0.015, 0.015]          # in mm
    transformDict : {nativeSys : 'Pixels', transforms : None}
    transposeDetector : False
    pitch : 0.0                         # (degrees)
    yaw : 0.0                           # rotation in plane of camera (degrees)
    roll : 0.0                          # (degrees)

    amplifiers : {}
#
# Now the guide cameras
#
# A single amplifier
#
AG_AMP0 : &AG_AMP0
    # trimmed
    hdu : 1                             # Only one HDU in the file

    flipXY :     [False, False]
    perAmpData : False                  # is the amp data split across multiple HDUs/Files?

    #                         [[x0,  y0], [xSize, ySize]]
    rawBBox                 : [[0,    0], [536,    1033]] # total size of one amp's raw data

    rawDataBBox             : [[24,   9], [512,    1024]] # data region in raw data
    rawSerialPrescanBBox    : [[0,    0], [8,      1033]] # serial prescan
    rawSerialOverscanBBox   : [[8,    0], [14,     1033]] # serial overscan
    rawParallelPrescanBBox  : [[0,    1], [0,         0]] # pixels digitised before first parallel transfer
    rawParallelOverscanBBox : [[0,    0], [536,       8]] # parallel overscan

    saturation : 65535                  # saturation level, DN XXX Should this be in electrons?

    # Linearity correction is still under discussion, so this is a placeholder.
    linearityType : PROPORTIONAL
    linearityThreshold : 0
    linearityMax : 65535                # == saturation
    linearityCoeffs : [0, 65535]        # == [linearityThreshold, linearityMax]

AG_AMP1 : &AG_AMP1
    << : *AG_AMP0
    #                         [[x0,  y0], [xSize, ySize]]
    rawBBox                 : [[0,    0], [536,    1033]] # total size of one amp's raw data

    rawDataBBox             : [[0,  9], [512,    1024]] # data region in raw data
    rawSerialPrescanBBox    : [[528, 0], [8,      1033]] # serial prescan
    rawSerialOverscanBBox   : [[514,    0], [14,     1033]] # serial overscan
    rawParallelPrescanBBox  : [[0,    1], [0,         0]] # pixels digitised before first parallel transfer
    rawParallelOverscanBBox : [[0,    0], [536,       8]] # parallel overscan

#
# A single detector;
#
AG_Detector : &AG_Detector
    detectorType : 4                    # AG CCD
    refpos : [536, 516.5]               # centre of chip
    offset : [.nan, .nan]
    #      [[x0,y0], [   x1,  y1]]
    bbox : [[0,  0], [1023, 1023]]      # total bbox of trimmed detector
    pixelSize : [0.015, 0.015]          # in mm (unknown)
    transformDict : {nativeSys : 'Pixels', transforms : None}
    transposeDetector : False
    pitch : 0.0                         # (degrees)
    yaw : 0.0                           # rotation in plane of camera (degrees)
    roll : 0.0                          # (degrees)

    amplifiers : {}
#
# Define our specific devices
#
# All the cameras present in this file.  Each camera is a Pair of Hamamatsu Detectors with 2*4 amplifiers
#
# Define our specific devices.  Some are HgCdTe -- change yamlCamera.py CCDs -> Detectors
#
# The layout specified by "offset" is:
#   n1 n2 n3 n4
#   r1 r2 r3 r4
#   b1 b2 b3 b4
# with 1% gaps between the chips
#
CCDs : &CCDs
    r1 : &CCD                           # Spectrograph 1, red arm
        << : *Detector
        detectorType : 0                # r CCD
        id : 1
        serial : Hamamatsu r1
        offset : [-93.1, 0.0]           # mm
        crosstalk : [
             0.00000000e+00,  5.38564932e-05, -7.82490268e-05, -3.45565116e-05,
             9.35358373e-05,  7.98132771e-05, -4.94429926e-17, -7.41401488e-10,
             6.86010281e-05,  0.00000000e+00,  4.06015986e-05, -4.89111280e-05,
             9.57337784e-05,  6.99770598e-05,  5.69664451e-06,  5.60858449e-05,
            -7.72221057e-05, -2.34880396e-05,  0.00000000e+00,  2.36965214e-04,
            -2.57151547e-05,  1.31974875e-04, -1.93367424e-06,  8.31754169e-05,
             3.16773291e-05, -1.03920801e-04,  2.09847500e-04,  0.00000000e+00,
             7.73841725e-05, -6.06011367e-05,  1.12668081e-05,  3.11522889e-04,
             4.81856786e-05,  1.27580695e-04,  4.69540406e-05,  1.62380394e-04,
             0.00000000e+00,  1.75393707e-05, -8.44858516e-07, -1.00662302e-04,
             7.52210429e-05,  1.05671483e-04,  1.25587604e-04,  4.31637395e-05,
             1.34897043e-04,  0.00000000e+00,  2.37918396e-06,  2.24346272e-05,
             7.35075037e-05,  1.48839907e-04,  3.41589306e-04,  7.26495824e-05,
             7.13033757e-05,  6.48765977e-05,  0.00000000e+00,  3.02225918e-05,
             3.96208133e-07,  1.08008306e-04,  5.25343482e-05,  9.67904078e-05,
            -2.12495016e-05, -5.22146249e-05, -3.88049702e-09,  0.00000000e+00,
        ]

        amplifiers:
            "0": &A0
                <<: *AMP
                ixy : [0, 0]
                readCorner : LL
                gain : 1.181
                readNoise : 4.423752
            "1": &A1
                <<: *A0
                ixy : [1, 0]
                readCorner : LR
                flipXY : [True, False]
                gain : 1.170
                readNoise : 4.266983
            "2": &A2
                <<: *A0
                ixy : [2, 0]
                gain : 1.174
                readNoise : 4.403465
            "3": &A3
                <<: *A1
                ixy : [3, 0]
                gain : 1.196
                readNoise : 4.178715
            "4": &A4
                <<: *A0
                ixy : [4, 0]
                gain : 1.250
                readNoise : 3.960904
            "5": &A5
                <<: *A1
                ixy : [5, 0]
                gain : 1.259
                readNoise : 4.411193
            "6": &A6
                <<: *A0
                ixy : [6, 0]
                gain : 1.248
                readNoise : 5.042430
            "7": &A7
                <<: *A1
                ixy : [7, 0]
                gain : 1.207
                readNoise : 4.181415
    m1 :  # m1 is actually r1
        <<: *CCD
        id : -1

    b1 :                                # Spectrograph 1, blue arm
        << : *Detector
        detectorType : 1                # b CCD
        id : 0
        serial : Hamamatsu b1
        offset : [-93.1, -65.1]         # mm

        amplifiers:
            "0":
                <<: *A0
                gain : 1.32
                readNoise : 6
            "1":
                <<: *A1
                gain : 1.31
                readNoise : 6
            "2":
                <<: *A2
                gain : 1.34
                readNoise : 6
            "3":
                <<: *A3
                gain : 1.26
                readNoise : 6
            "4":
                <<: *A4
                gain : 1.36
                readNoise : 6
            "5":
                <<: *A5
                gain : 1.31
                readNoise : 6
            "6":
                <<: *A6
                gain : 1.34
                readNoise : 6
            "7":
                <<: *A7
                gain : 1.26
                readNoise : 6

    n1 : &n1
        <<: *CCD
        id : 2
        serial : "TBD"
        offset : [-93.1, 65.1]           # mm

        amplifiers:                     # really only 1 amplifier (well, really 16M amplifiers but treat as 1)
            "0":
                <<: *A0
                gain : 1.00             # will be multiplied by W_H4GAIN
                readNoise : 10
            "1":
                <<: *A1
                gain : 1.00
                readNoise : 10
            "2":
                <<: *A2
                gain : 1.00
                readNoise : 10
            "3":
                <<: *A3
                gain : 1.00
                readNoise : 10
            "4":
                <<: *A4
                gain : 1.00
                readNoise : 10
            "5":
                <<: *A5
                gain : 1.00
                readNoise : 10
            "6":
                <<: *A6
                gain : 1.00
                readNoise : 10
            "7":
                <<: *A7
                gain : 1.00
                readNoise : 10

    b2:
      <<: *CCD
      id: 3
      serial : Hamamatsu b2
      offset : [-28.0, -65.1]         # mm
    r2: &r2
      <<: *CCD
      id: 4
      serial : Hamamatsu r2
      offset : [-28.0, 0.0]           # mm
    n2:
      <<: *n1
      id: 5
      serial : "18660"
      offset : [-28.0, 65.1]           # mm
    m2:                                # == r2
      <<: *r2
      id: -4

    b3:
      <<: *CCD
      id: 6
      serial : Hamamatsu b3
      offset : [37.1, -65.1]         # mm
    r3: &r3
      <<: *CCD
      id: 7
      serial : Hamamatsu r3
      offset : [37.1, 0.0]           # mm
    n3:
      <<: *n1
      id: 8
      serial : "18315"
      offset : [37.1, 65.1]           # mm
    m3:
      <<: *r3
      id: -7                            # == r3
      offset : [37.1, 130.2]         # mm

    b4:
      <<: *CCD
      id: 9
      serial : Hamamatsu b4
      offset : [102.2, -65.1]         # mm
    r4: &r4
      <<: *CCD
      id: 10
      serial : Hamamatsu r4
      offset : [102.2, 0.0]           # mm
    n4:
      <<: *n1
      id: 11
      serial : "TBD"
      offset : [102.2, 65.1]           # mm
    m4:
      <<: *r4
      id: -10
    #
    # Now the autoguiders
    #
    AG1 :
        << : *AG_Detector
        id : 101
        serial : AG 1
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0": &AG_A0
                <<: *AG_AMP0
                ixy : [0, 0]
                readCorner : LL
                gain :  1.015
                readNoise : 1

            "1": &AG_A1
                <<: *AG_AMP1
                ixy : [1, 0]
                readCorner : LR
                gain : 0.985
                readNoise : 1

    AG2 :
        << : *AG_Detector
        id : 102
        serial : AG 2
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain :  1.024

            "1":
                <<: *AG_A1
                gain : 0.976

    AG3 :
        << : *AG_Detector
        id : 103
        serial : AG 3
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 0.931

            "1":
                <<: *AG_A1
                gain : 1.069

    AG4 :
        << : *AG_Detector
        id : 104
        serial : AG 4
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 1.002

            "1":
                <<: *AG_A1
                gain : 0.998

    AG5 :
        << : *AG_Detector
        id : 105
        serial : AG 5
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 0.985

            "1":
                <<: *AG_A1
                gain : 1.015

    AG6 :
        << : *AG_Detector
        id : 106
        serial : AG 6
        offset : [-93.1, 0.0]           # mm

        amplifiers:
            "0":
                <<: *AG_A0
                gain : 0.994

            "1":
                <<: *AG_A1
                gain : 1.006
